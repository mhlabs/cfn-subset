{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Transform": [
    {
      "Name": "env-pubsub-Subscription",
      "Parameters": {
        "TopicImportKey": "ecom-in-home-delivery-PostalAreaTopic",
        "QueueResource": "PostalAreaQueue",
        "Name": "PostalAreaSync"
      }
    },
    {
      "Name": "env-pubsub-Subscription",
      "Parameters": {
        "TopicImportKey": "ecom-in-home-delivery-PostalCodeTopic",
        "QueueResource": "PostalCodeQueue",
        "Name": "PostalCodeSync"
      }
    },
    {
      "Name": "env-event-utils-DynamoTrigger",
      "Parameters": {
        "TableName": "Address",
        "EventBusName": "commerce"
      }
    },
    {
      "Name": "env-deployhooks-macro-SmokeTest",
      "Parameters": {
        "LambdaResource": "ApiProxy",
        "Runtime": "dotnetcore3.1"
      }
    },
    "int-feature-flags-Macro",
    "AWS::Serverless-2016-10-31"
  ],
  "Description": "An AWS Serverless Application created with mhdev-cli",
  "Parameters": {
    "DynamoBackup": {
      "Type": "String",
      "AllowedValues": [
        "True",
        "False"
      ]
    },
    "HealthCheckAddressId": { 
      "Type": "String",
      "Description": "AddressId used by healthchecks"
    }
  },
  "Globals": {
    "Function": {
      "Runtime": "dotnetcore3.1",
      "Tracing": "Active",
      "Environment": {
        "Variables" : {
          "ApiBaseUrl": {
            "Fn::ImportValue": "ApiGatewayBaseUrl"
          }
        }
      }
    }
  },
  "Resources": {
    "ApiProxy": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "address_service::address_service.LambdaEntryPoint::FunctionHandlerAsync",
        "Runtime": "dotnetcore3.1",
        "CodeUri": "output",
        "MemorySize": 3008,
        "Timeout": 30,
        "Role": null,
        "Policies": [
          "AmazonAPIGatewayInvokeFullAccess",
		  {
			"DynamoDBCrudPolicy": {
				"TableName": { "Ref": "Address" }
			}
		  },
		  {
			"DynamoDBCrudPolicy": {
				"TableName": { "Ref": "DeliveryCoordinatesTable" }
			}
		  },
		  {
			"DynamoDBCrudPolicy": {
				"TableName": { "Ref": "PostalCode" }
			}
		  },
		  {
			"DynamoDBCrudPolicy": {
				"TableName": { "Ref": "PostalArea" }
			}
		  }
        ],
        "Environment": {
          "Variables": {
            "AddressTable": {
              "Ref": "Address"
            },
            "DeliveryCoordinatesTable": {
              "Ref": "DeliveryCoordinatesTable"
            },
            "PostalCodeTable": {
              "Ref": "PostalCode"
            },
            "PostalAreaTable": {
              "Ref": "PostalArea"
            },
            "HealthCheckAddressId": {
              "Ref": "HealthCheckAddressId"
            }
          }
        }
      }
    },
    "Api": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": {
          "Fn::Sub": "https://s3-eu-west-1.amazonaws.com/${AWS::AccountId}-cf-templates/webapi.template"
        },
        "Parameters": {
          "ApiProxyArn": {
            "Fn::GetAtt": [
              "ApiProxy",
              "Arn"
            ]
          },
          "ParentStackName": {
            "Ref": "AWS::StackName"
          },
          "KeepAlive": "true"
        }
      }
    },
    "Address": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "BillingMode": "PAY_PER_REQUEST",
        "PointInTimeRecoverySpecification": {
          "PointInTimeRecoveryEnabled": {
            "Ref": "DynamoBackup"
          }
        },
        "AttributeDefinitions": [
          {
            "AttributeName": "Id",
            "AttributeType": "S"
          },
          {
            "AttributeName": "MemberId",
            "AttributeType": "S"
          },
          {
            "AttributeName": "LegacyAddressId",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "Id",
            "KeyType": "HASH"
          }
        ],
        "GlobalSecondaryIndexes": [
          {
            "IndexName": "GsiMemberIdAddressId",
            "KeySchema": [
              {
                "AttributeName": "MemberId",
                "KeyType": "HASH"
              },
              {
                "AttributeName": "Id",
                "KeyType": "RANGE"
              }
            ],
            "Projection": {
              "ProjectionType": "ALL"
            }
          },
          {
            "IndexName": "GsiMemberId",
            "KeySchema": [
              {
                "AttributeName": "MemberId",
                "KeyType": "HASH"
              }
            ],
            "Projection": {
              "ProjectionType": "ALL"
            }
          },
          {
            "IndexName": "GsiLegacyAddressId",
            "KeySchema": [
              {
                "AttributeName": "LegacyAddressId",
                "KeyType": "HASH"
              }
            ],
            "Projection": {
              "ProjectionType": "ALL"
            }
          }
        ],
        "StreamSpecification": {
          "StreamViewType": "NEW_AND_OLD_IMAGES"
        }
      }
    },
    "DeliveryCoordinatesTable": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "BillingMode": "PAY_PER_REQUEST",
        "PointInTimeRecoverySpecification": {
          "PointInTimeRecoveryEnabled": {
            "Ref": "DynamoBackup"
          }
        },
        "AttributeDefinitions": [
          {
            "AttributeName": "Id",
            "AttributeType": "S"
          },
          {
            "AttributeName": "MemberId",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "Id",
            "KeyType": "HASH"
          },
          {
            "AttributeName": "MemberId",
            "KeyType": "RANGE"
          }
        ],
        "GlobalSecondaryIndexes": [
          {
            "IndexName": "GsiMemberIdDeliveryCoordinates",
            "KeySchema": [
              {
                "AttributeName": "MemberId",
                "KeyType": "HASH"
              }
            ],
            "Projection": {
              "ProjectionType": "ALL"
            }
          }
        ]
      }
    },
    "ProcessStream": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "address_service::address_service.Functions.StreamProcessor::Process",
        "Runtime": "dotnetcore3.1",
        "CodeUri": "output",
        "MemorySize": 256,
        "Timeout": 30,
        "Role": null,
        "Policies": [
          {
			"DynamoDBCrudPolicy": {
				"TableName": { "Ref": "Address" }
			}
		  }
        ],
        "Environment": {
          "Variables": {
            "AddressTable": {
              "Ref": "Address"
            }
          }
        },
        "Events": {
          "PutResource": {
            "Type": "Kinesis",
            "Properties": {
              "BatchSize": 50,
              "StartingPosition": "TRIM_HORIZON",
              "Stream": {
                "Fn::ImportValue": "address-stream-Arn"
              }
            }
          }
        }
      }
    },
    "PostalCode": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "AttributeDefinitions": [
          {
            "AttributeName": "Code",
            "AttributeType": "N"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "Code",
            "KeyType": "HASH"
          }
        ],
        "BillingMode": "PAY_PER_REQUEST"
      }
    },
    "PostalArea": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "AttributeDefinitions": [
          {
            "AttributeName": "Area",
            "AttributeType": "N"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "Area",
            "KeyType": "HASH"
          }
        ],
        "BillingMode": "PAY_PER_REQUEST"
      }
    },
    "PostalAreaQueue": {
      "Type": "AWS::SQS::Queue"
    },
    "PostalCodeQueue": {
      "Type": "AWS::SQS::Queue"
    },
    "PostalCodeQueueConsumer": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "address_service::address_service.Functions.PostalCodeQueueConsumer::Process",
        "Runtime": "dotnetcore3.1",
        "CodeUri": "output",
        "MemorySize": 256,
        "Timeout": 30,
        "Policies": [
          {
			"DynamoDBCrudPolicy": {
				"TableName": { "Ref": "PostalCode" }
			}
		  }
        ],
        "Tracing": "Active",
        "Environment": {
          "Variables": {
            "PostalCodeTable": { "Ref": "PostalCode" }
          }
        },
        "Events": {
          "SQS": {
            "Type": "SQS",
            "Properties": {
              "Queue": {
                "Fn::GetAtt": [
                  "PostalCodeQueue",
                  "Arn"
                ]
              },
              "BatchSize": 10
            }
          }
        }
      }
    },
    "PostalAreaQueueConsumer": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Handler": "address_service::address_service.Functions.PostalAreaQueueConsumer::Process",
        "Runtime": "dotnetcore3.1",
        "CodeUri": "output",
        "MemorySize": 256,
        "Timeout": 30,
        "Policies": [
          {
			"DynamoDBCrudPolicy": {
				"TableName": { "Ref": "PostalArea" }
			}
		  }
        ],
        "Tracing": "Active",
        "Environment": {
          "Variables": {
            "PostalAreaTable": { "Ref": "PostalArea" }
          }
        },
        "Events": {
          "SQS": {
            "Type": "SQS",
            "Properties": {
              "Queue": {
                "Fn::GetAtt": [
                  "PostalAreaQueue",
                  "Arn"
                ]
              },
              "BatchSize": 10
            }
          }
        }
      }
    },
    "AddressEventTopic": {
      "Type": "AWS::SNS::Topic"
    },
    "AddressTrigger": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "Fn::Transform": {
          "Name": "env-pubsub-Producer"
        },
        "Handler": "address_service::address_service.Functions.AddressTrigger::Process",
        "CodeUri": "output",
        "Runtime": "dotnetcore3.1",
        "MemorySize": 512,
        "Timeout": 30,
        "Policies": [
          {
            "SNSPublishMessagePolicy": {
              "TopicName": { "Fn::GetAtt": [ "AddressEventTopic", "TopicName" ] }
            }
          }
        ],
        "Environment": {
          "Variables": {
            "AddressEventTopic": {
              "Ref": "AddressEventTopic"
            }
          }
        },
        "Events": {
          "DynamoDB": {
            "Type": "DynamoDB",
            "Properties": {
              "Stream": {
                "Fn::GetAtt": [
                  "Address",
                  "StreamArn"
                ]
              },
              "StartingPosition": "LATEST",
              "BatchSize": 10,
              "Enabled": true
            }
          }
        }
      }
    }
  },
  "Outputs": {
	"AddressEventTopicExport": {
        "Value": {
			"Ref": "AddressEventTopic"
        },
        "Export": {
            "Name": {
                "Fn::Sub": "${AWS::StackName}-AddressEventTopic"
            }
        }
    }
  }
}